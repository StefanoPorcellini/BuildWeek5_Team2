@model ClinicaVeterinaria.Models.Animale

@{
    ViewData["Title"] = "Create Animale with Proprietario";
}

<h1>Crea Nuovo Animale e Proprietario</h1>

<form asp-action="CreateWithProprietario" enctype="multipart/form-data">
    <h2>Dati Animale</h2>
    <!-- Dati Animale -->
    <div class="form-group">
        <label asp-for="Nome" class="control-label"></label>
        <input asp-for="Nome" class="form-control" />
        <span asp-validation-for="Nome" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="TipologiaAnimale" class="control-label">Tipologia Animale</label>
        <input asp-for="TipologiaAnimale" class="form-control" />
        <span asp-validation-for="TipologiaAnimale" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="ColoreManto" class="control-label">Colore Manto</label>
        <input asp-for="ColoreManto" class="form-control" />
        <span asp-validation-for="ColoreManto" class="text-danger"></span>
    </div>
    <div class="form-group">
        <label asp-for="DataNascita" class="control-label">Data Nascita</label>
        <input asp-for="DataNascita" class="form-control" type="date" />
        <span asp-validation-for="DataNascita" class="text-danger"></span>
    </div>
    <div class="form-group">
        <div class="form-check">
            <input asp-for="PossiedeChip" class="form-check-input" type="checkbox" id="PossiedeChipCheckbox" />
            <label asp-for="PossiedeChip" class="form-check-label">Possiede Chip</label>
            <span asp-validation-for="PossiedeChip" class="text-danger"></span>
        </div>
    </div>
    <div class="form-group" id="NumeroChipField" style="display:none;">
        <label asp-for="NumeroChip" class="control-label">Numero Chip</label>
        <input asp-for="NumeroChip" class="form-control" />
        <span asp-validation-for="NumeroChip" class="text-danger"></span>
    </div>
    <div class="form-group">
        <div class="form-check">
            <input asp-for="Randagio" class="form-check-input" type="checkbox" id="RandagioCheckbox" />
            <label asp-for="Randagio" class="form-check-label"></label>
            <span asp-validation-for="Randagio" class="text-danger"></span>
        </div>
    </div>
    <div class="form-group">
        <label asp-for="Foto" class="control-label"></label>
        <input asp-for="Foto" class="form-control" type="file" />
        <span asp-validation-for="Foto" class="text-danger"></span>
    </div>

    <!-- Sezione per la ricerca del proprietario -->
    <h2>Dati Proprietario</h2>
    <div class="form-group">
        <label for="searchTerm" class="control-label">Cerca Proprietario Esistente</label>
        <input type="text" id="searchTerm" class="form-control" placeholder="Cerca per Nome, Cognome o Codice Fiscale" />
        <button type="button" id="searchButton" class="btn btn-primary mt-2">Cerca</button>
    </div>
    <div id="searchResults" class="mt-3"></div>

    <!-- Form per inserire i dati del proprietario (visibile solo se non selezionato un proprietario esistente) -->
    <div id="proprietarioForm">
        <div class="form-group">
            <label for="ProprietarioNome" class="control-label">Nome</label>
            <input id="ProprietarioNome" name="ProprietarioNome" class="form-control" />
        </div>
        <div class="form-group">
            <label for="ProprietarioCognome" class="control-label">Cognome</label>
            <input id="ProprietarioCognome" name="ProprietarioCognome" class="form-control" />
        </div>
        <div class="form-group">
            <label for="ProprietarioTelefono" class="control-label">Telefono</label>
            <input id="ProprietarioTelefono" name="ProprietarioTelefono" class="form-control" />
        </div>
        <div class="form-group">
            <label for="ProprietarioIndirizzo" class="control-label">Indirizzo</label>
            <input id="ProprietarioIndirizzo" name="ProprietarioIndirizzo" class="form-control" />
        </div>
        <div class="form-group">
            <label for="ProprietarioCitta" class="control-label">Città</label>
            <input id="ProprietarioCitta" name="ProprietarioCitta" class="form-control" />
        </div>
        <div class="form-group">
            <label for="ProprietarioCodiceFiscale" class="control-label">Codice Fiscale</label>
            <input id="ProprietarioCodiceFiscale" name="ProprietarioCodiceFiscale" class="form-control" />
        </div>
    </div>

    <!-- Dati del proprietario selezionato (inizialmente nascosti) -->
    <div id="proprietarioSelezionato" style="display:none;">
        <h4>Proprietario Selezionato:</h4>
        <p><strong>Nome:</strong> <span id="selectedNome"></span></p>
        <p><strong>Cognome:</strong> <span id="selectedCognome"></span></p>
        <p><strong>Telefono:</strong> <span id="selectedTelefono"></span></p>
        <p><strong>Indirizzo:</strong> <span id="selectedIndirizzo"></span></p>
        <p><strong>Città:</strong> <span id="selectedCitta"></span></p>
        <p><strong>Codice Fiscale:</strong> <span id="selectedCodiceFiscale"></span></p>
        <input type="hidden" id="ProprietarioId" name="ProprietarioId" />
    </div>

    <button type="submit" class="btn btn-primary my-2">Crea</button>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        // Funzione di toggle per visualizzare il campo Numero Chip
        document.getElementById("PossiedeChipCheckbox").addEventListener("change", function () {
            var chipField = document.getElementById("NumeroChipField");
            if (this.checked) {
                chipField.style.display = "block";
            } else {
                chipField.style.display = "none";
            }
        });

        // Funzione per cercare i proprietari nel database
        $(document).ready(function () {
            $("#searchButton").click(function () {
                var searchTerm = $("#searchTerm").val();
                if (searchTerm.trim() !== "") {
                    $.ajax({
                        url: '@Url.Action("Search", "Proprietari")',
                        type: "GET",
                        data: { term: searchTerm },
                        success: function (data) {
                            var results = $("#searchResults");
                            results.empty();
                            if (data.length > 0) {
                                data.forEach(function (proprietario) {
                                    results.append(`
                                                        <div class="card mb-2">
                                                            <div class="card-body">
                                                                <h5 class="card-title">${proprietario.nome} ${proprietario.cognome}</h5>
                                                                <p class="card-text">
                                                                    <strong>Codice Fiscale:</strong> ${proprietario.codiceFiscale}<br>
                                                                    <strong>Telefono:</strong> ${proprietario.telefono}<br>
                                                                    <strong>Indirizzo:</strong> ${proprietario.indirizzo}, ${proprietario.citta}
                                                                </p>
                                                                <button type="button" class="btn btn-success selectProprietarioButton" data-id="${proprietario.id}" data-nome="${proprietario.nome}" data-cognome="${proprietario.cognome}" data-telefono="${proprietario.telefono}" data-indirizzo="${proprietario.indirizzo}" data-citta="${proprietario.citta}" data-codicefiscale="${proprietario.codiceFiscale}">Seleziona</button>
                                                            </div>
                                                        </div>
                                                    `);
                                });
                            } else {
                                results.append("<p>Nessun proprietario trovato.</p>");
                            }
                        }
                    });
                }
            });

            // Funzione per selezionare un proprietario
            $(document).on("click", ".selectProprietarioButton", function () {
                var id = $(this).data("id");
                var nome = $(this).data("nome");
                var cognome = $(this).data("cognome");
                var telefono = $(this).data("telefono");
                var indirizzo = $(this).data("indirizzo");
                var citta = $(this).data("citta");
                var codiceFiscale = $(this).data("codicefiscale");

                // Nascondi il form del proprietario e mostra i dettagli del proprietario selezionato
                $("#proprietarioForm").hide();
                $("#proprietarioSelezionato").show();

                // Popola i dati del proprietario selezionato
                $("#selectedNome").text(nome);
                $("#selectedCognome").text(cognome);
                $("#selectedTelefono").text(telefono);
                $("#selectedIndirizzo").text(indirizzo);
                $("#selectedCitta").text(citta);
                $("#selectedCodiceFiscale").text(codiceFiscale);

                // Assegna il valore di ProprietarioId
                $("#ProprietarioId").val(id);

                // Verifica di debug
                console.log("Proprietario selezionato ID: " + id);
            });
        });
    </script>
}
